<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My registration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #fff;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .status-filter {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .status-btn {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .status-btn.active {
            background-color: #1890ff;
            color: white;
        }
        
        .registration-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .registration-item {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .registration-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .activity-cover {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .activity-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .activity-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .activity-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .registration-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff7e6;
            color: #fa8c16;
        }
        
        .status-approved {
            background-color: #f6ffed;
            color: #52c41a;
        }
        
        .status-rejected {
            background-color: #fff2f0;
            color: #ff4d4f;
        }
        
        .status-history {
            background-color: #f0f0f0;
            color: #666;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1890ff;
            color: white;
        }
        
        .btn-success {
            background-color: #52c41a;
            color: white;
        }
        
        .btn-danger {
            background-color: #ff4d4f;
            color: white;
        }
        
        .btn-default {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-warning {
            background-color: #fa8c16;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-header {
            margin-bottom: 20px;
            padding-right: 30px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state img {
            width: 100px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .checkin-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status-success {
            background-color: #f6ffed;
            color: #52c41a;
        }
        
        .status-not_checked_in {
            background-color: #fff7e6;
            color: #fa8c16;
        }
        
        .qrcode-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .qrcode {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            padding: 10px;
        }
        
        .checkin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .checkin-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .checkin-tab.active {
            border-bottom-color: #1890ff;
            color: #1890ff;
        }
        
        .checkin-content {
            display: none;
        }
        
        .checkin-content.active {
            display: block;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .registration-item {
                flex-direction: column;
            }
            
            .activity-cover {
                width: 100%;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>My registration</h1>
            <div class="status-filter">
                <button class="status-btn active" data-status="all">All</button>
                <button class="status-btn" data-status="pending">Pending review</button>
                <button class="status-btn" data-status="approved">Passed</button>
                <button class="status-btn" data-status="rejected">Rejected</button>
                <button class="status-btn" data-status="history">history</button>
            </div>
        </header>
        
        <main>
            <div class="registration-list" id="registrationList">
                <div class="loading">loading...</div>
            </div>
        </main>
    </div>
    
    <!-- 报名详情模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="modal-close" id="closeModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Registration details</h2>
            </div>
            <div id="modalBody">
                <!-- 动态内容 -->
            </div>
        </div>
    </div>
    
    <!-- 签到模态框 -->
    <div class="modal" id="checkinModal">
        <div class="modal-content">
            <span class="modal-close" id="closeCheckinModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Event check-in</h2>
            </div>
            <div id="checkinModalBody">
                <!-- 动态内容 -->
            </div>
        </div>
    </div>
    
    <!-- 补签申请模态框 -->
    <div class="modal" id="makeupModal">
        <div class="modal-content">
            <span class="modal-close" id="closeMakeupModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Apply for supplementary visa</h2>
            </div>
            <div id="makeupModalBody">
                <!-- 动态内容 -->
            </div>
        </div>
    </div>
    
    <script>
        // API基础URL
        const API_BASE = '/api';
        
        // 全局状态
        let currentStatus = 'all';
        let currentPage = 1;
        let isLoading = false;
        let currentActivityId = null;
        
        // DOM元素
        const registrationList = document.getElementById('registrationList');
        const statusButtons = document.querySelectorAll('.status-btn');
        const detailModal = document.getElementById('detailModal');
        const closeModal = document.getElementById('closeModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        
        const checkinModal = document.getElementById('checkinModal');
        const closeCheckinModal = document.getElementById('closeCheckinModal');
        const checkinModalBody = document.getElementById('checkinModalBody');
        
        const makeupModal = document.getElementById('makeupModal');
        const closeMakeupModal = document.getElementById('closeMakeupModal');
        const makeupModalBody = document.getElementById('makeupModalBody');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadRegistrations();
            
            // 状态筛选事件
            statusButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    statusButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStatus = btn.dataset.status;
                    currentPage = 1;
                    loadRegistrations();
                });
            });
            
            // 关闭模态框
            closeModal.addEventListener('click', () => {
                detailModal.style.display = 'none';
            });
            
            closeCheckinModal.addEventListener('click', () => {
                checkinModal.style.display = 'none';
            });
            
            closeMakeupModal.addEventListener('click', () => {
                makeupModal.style.display = 'none';
            });
            
            // 点击模态框外部关闭
            detailModal.addEventListener('click', (e) => {
                if (e.target === detailModal) {
                    detailModal.style.display = 'none';
                }
            });
            
            checkinModal.addEventListener('click', (e) => {
                if (e.target === checkinModal) {
                    checkinModal.style.display = 'none';
                }
            });
            
            makeupModal.addEventListener('click', (e) => {
                if (e.target === makeupModal) {
                    makeupModal.style.display = 'none';
                }
            });
            
            // 下拉刷新和上拉加载
            let startY = 0;
            let currentY = 0;
            
            document.addEventListener('touchstart', (e) => {
                startY = e.touches[0].pageY;
            });
            
            document.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].pageY;
            });
            
            document.addEventListener('touchend', () => {
                const diff = currentY - startY;
                
                // 下拉刷新
                if (diff > 50 && window.scrollY === 0) {
                    currentPage = 1;
                    loadRegistrations();
                }
                
                // 上拉加载更多
                if (diff < -50 && 
                    window.innerHeight + window.scrollY >= document.body.offsetHeight - 50) {
                    loadMoreRegistrations();
                }
            });
        });
        
        // 加载报名列表
        async function loadRegistrations() {
            try {
                registrationList.innerHTML = '<div class="loading">loading...</div>';
                
                const response = await fetch(
                    `${API_BASE}/user/registrations?status=${currentStatus}&page=${currentPage}`
                );
                const result = await response.json();
                
                if (result.success) {
                    displayRegistrations(result.data.registrations);
                } else {
                    registrationList.innerHTML = '<div class="empty-state">Loading failed, please try again.</div>';
                }
            } catch (error) {
                console.error('Failed to load registration list:', error);
                registrationList.innerHTML = '<div class="empty-state">Network error, please check your connection.</div>';
            }
        }
        
        // 加载更多报名
        async function loadMoreRegistrations() {
            if (isLoading) return;
            
            isLoading = true;
            currentPage++;
            
            try {
                const response = await fetch(
                    `${API_BASE}/user/registrations?status=${currentStatus}&page=${currentPage}`
                );
                const result = await response.json();
                
                if (result.success) {
                    const existingItems = registrationList.querySelectorAll('.registration-item');
                    const newItems = createRegistrationElements(result.data.registrations);
                    
                    // 移除加载提示
                    const loadingIndicator = registrationList.querySelector('.loading-more');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    // 添加新项目
                    newItems.forEach(item => registrationList.appendChild(item));
                    
                    // 如果没有更多数据，显示提示
                    if (result.data.registrations.length === 0) {
                        registrationList.innerHTML += '<div class="empty-state">No more data available.</div>';
                    }
                }
            } catch (error) {
                console.error('Load more registration failed:', error);
                currentPage--; // 恢复页码
            } finally {
                isLoading = false;
            }
        }
        
        // 显示报名列表
        function displayRegistrations(registrations) {
            if (registrations.length === 0) {
                registrationList.innerHTML = `
                    <div class="empty-state">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQ0IDI0SDE2QzE0LjM0MzEgMjQgMTMgMjUuMzQzMSAxMyAyN1Y0NEMxMyA0NS42NTY5IDE0LjM0MzEgNDcgMTYgNDdINDhDNDkuNjU2OSA0NyA1MSA0NS42NTY5IDUxIDQ0VjI3QzUxIDI1LjM0MzEgNDkuNjU2OSAyNCA0OCAyNFoiIGZpbGw9IiNEOEQ4RDgiLz4KPHBhdGggZD0iTTM1LjUgMjRIMzQuNUMzMy42NzE2IDI0IDMzIDIzLjMyODQgMzMgMjIuNVYxOC41QzMzIDE2LjAxNDcgMzAuOTg1MyAxNCAyOC41IDE0QzI2LjAxNDcgMTQgMjQgMTYuMDE0NyAyNCAxOC41VjIyLjVDMjQgMjMuMzI4NCAyMy4zMjg0IDI0IDIyLjUgMjRIMjEuNUMxOS4wMTQ3IDI0IDE3IDI2LjAxNDcgMTcgMjguNVYzOS41QzE3IDQxLjk4NTMgMTkuMDE0NyA0NCAyMS41IDQ0SDM1LjVDMzcuOTg1MyA0NCA0MCA0MS45ODUzIDQwIDM5LjVWMjguNUM0MCAyNi4wMTQ3IDM3Ljk4NTMgMjQgMzUuNSAyNFoiIGZpbGw9IiNEOEQ4RDgiLz4KPC9zdmc+Cg==" alt="空状态">
                        <p>No registration records yet</p>
                    </div>
                `;
                return;
            }
            
            registrationList.innerHTML = '';
            const elements = createRegistrationElements(registrations);
            elements.forEach(element => registrationList.appendChild(element));
        }
        
        // 创建报名列表元素
        function createRegistrationElements(registrations) {
            return registrations.map(registration => {
                const item = document.createElement('div');
                item.className = 'registration-item';
                item.dataset.id = registration.id;
                
                // 状态文本和类名
                let statusText = '';
                let statusClass = '';
                
                switch(registration.status) {
                    case 'pending':
                        statusText = 'Pending review';
                        statusClass = 'status-pending';
                        break;
                    case 'approved':
                        statusText = 'Passed';
                        statusClass = 'status-approved';
                        break;
                    case 'rejected':
                        statusText = 'Rejected';
                        statusClass = 'status-rejected';
                        break;
                    case 'history':
                        statusText = 'ended';
                        statusClass = 'status-history';
                        break;
                }
                
                // 格式化时间
                const activityTime = new Date(registration.activityTime).toLocaleString();
                
                item.innerHTML = `
                    <img src="${registration.activityCover}" alt="${registration.activityTitle}" class="activity-cover">
                    <div class="activity-info">
                        <div>
                            <div class="activity-title">${registration.activityTitle}</div>
                            <div class="activity-meta">Activity time: ${activityTime}</div>
                            <div class="activity-meta">Place: ${registration.location}</div>
                        </div>
                        <div>
                            <span class="registration-status ${statusClass}">${statusText}</span>
                            <div class="action-buttons">
                                ${registration.status === 'pending' ? 
                                    `<button class="btn btn-default" onclick="editRegistration(${registration.id})">Revise</button>
                                     <button class="btn btn-danger" onclick="cancelRegistration(${registration.id})">Cancel</button>` : 
                                    ''}
                                ${registration.status === 'approved' ? 
                                    `<button class="btn btn-primary" onclick="showCheckinOptions(${registration.activityId})">Sign in</button>
                                     <button class="btn btn-primary" onclick="toggleReminder(${registration.id}, ${!registration.reminderSet})">
                                        ${registration.reminderSet ? 'Cancel reminder' : 'Set reminder'}
                                    </button>` : 
                                    ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // 点击查看详情
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('btn')) {
                        showRegistrationDetail(registration.id);
                    }
                });
                
                return item;
            });
        }
        
        // 显示报名详情
        async function showRegistrationDetail(id) {
            try {
                const response = await fetch(`${API_BASE}/registrations/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const registration = result.data;
                    
                    // 获取签到状态
                    const checkinStatusResponse = await fetch(`${API_BASE}/activities/${registration.activityId}/checkin-status`);
                    const checkinStatusResult = await checkinStatusResponse.json();
                    
                    let checkinStatusHtml = '';
                    if (checkinStatusResult.success) {
                        const checkinStatus = checkinStatusResult.data;
                        let statusText = '';
                        let statusClass = '';
                        
                        switch(checkinStatus.checkinStatus) {
                            case 'success':
                                statusText = 'Signed in';
                                statusClass = 'status-success';
                                break;
                            case 'not_checked_in':
                                statusText = 'Not signed in';
                                statusClass = 'status-not_checked_in';
                                break;
                            default:
                                statusText = checkinStatus.checkinStatus;
                                statusClass = 'status-not_checked_in';
                        }
                        
                        checkinStatusHtml = `<span class="checkin-status ${statusClass}">${statusText}</span>`;
                        
                        if (checkinStatus.checkinTime) {
                            const checkinTime = new Date(checkinStatus.checkinTime).toLocaleString();
                            checkinStatusHtml += `<div class="activity-meta">Check-in time: ${checkinTime}</div>`;
                        }
                    }
                    
                    // 格式化时间
                    const applyTime = new Date(registration.applyTime).toLocaleString();
                    const auditTime = registration.auditTime ? 
                        new Date(registration.auditTime).toLocaleString() : 'Not reviewed';
                    const activityTime = new Date(registration.activityTime).toLocaleString();
                    
                    // 状态文本
                    let statusText = '';
                    switch(registration.status) {
                        case 'pending': statusText = 'Pending review'; break;
                        case 'approved': statusText = 'Passed'; break;
                        case 'rejected': statusText = 'Rejected'; break;
                        case 'history': statusText = 'ended'; break;
                    }
                    
                    modalTitle.textContent = registration.activityTitle;
                    modalBody.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <img src="${registration.activityCover}" alt="${registration.activityTitle}" style="width: 100%; border-radius: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">Event information</div>
                            <div>Time: ${activityTime}</div>
                            <div>Place: ${registration.location}</div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">Registration status</div>
                            <span class="registration-status status-${registration.status}">${statusText}</span>
                            ${checkinStatusHtml}
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">Registration time</div>
                            <div>${applyTime}</div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">review time</div>
                            <div>${auditTime}</div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">Registration information</div>
                            <div>Name: ${registration.formData.name}</div>
                            <div>Telephone: ${registration.formData.phone}</div>
                            <div>email: ${registration.formData.email}</div>
                        </div>
                        
                        <div class="action-buttons">
                            ${registration.status === 'pending' ? 
                                `<button class="btn btn-primary" onclick="editRegistration(${registration.id})">Modify registration information</button>
                                 <button class="btn btn-danger" onclick="cancelRegistration(${registration.id})">Cancel registration</button>` : 
                                ''}
                            
                            ${registration.status === 'approved' ? 
                                `<button class="btn btn-success" onclick="showCheckinOptions(${registration.activityId})">Sign in</button>
                                 <button class="btn btn-primary" onclick="toggleReminder(${registration.id}, ${!registration.reminderSet})">
                                    ${registration.reminderSet ? 'Cancel event reminder' : 'Set event reminders'}
                                 </button>
                                 <button class="btn btn-warning" onclick="showMakeupApplication(${registration.activityId})">Apply for supplementary visa</button>` : 
                                ''}
                        </div>
                    `;
                    
                    detailModal.style.display = 'flex';
                }
            } catch (error) {
                console.error('Failed to retrieve registration details:', error);
                alert('Failed to retrieve details, please try again.');
            }
        }
        
        // 显示签到选项
        async function showCheckinOptions(activityId) {
            currentActivityId = activityId;
            
            try {
                // 获取活动二维码
                const qrCodeResponse = await fetch(`${API_BASE}/activities/${activityId}/qrcode`);
                const qrCodeResult = await qrCodeResponse.json();
                
                let qrCodeHtml = '';
                if (qrCodeResult.success) {
                    qrCodeHtml = `
                        <div class="qrcode-container">
                            <div class="form-label">Scan the QR code to check in</div>
                            <img src="${qrCodeResult.data.qrCode}" alt="Event QR code" class="qrcode">
                            <div style="margin-top: 10px; font-size: 14px; color: #666;">Please scan the QR code with your mobile phone to check in.</div>
                        </div>
                    `;
                }
                
                checkinModalBody.innerHTML = `
                    <div class="checkin-tabs">
                        <div class="checkin-tab active" data-tab="qrcode">Scan QR code to check in</div>
                        <div class="checkin-tab" data-tab="code">Sign-in code sign-in</div>
                    </div>
                    
                    <div class="checkin-content active" id="qrcodeContent">
                        ${qrCodeHtml}
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="simulateQRCodeCheckin(${activityId})">Simulated QR code check-in</button>
                        </div>
                    </div>
                    
                    <div class="checkin-content" id="codeContent">
                        <div class="form-group">
                            <label class="form-label">Please enter your check-in code.</label>
                            <input type="text" class="form-control" id="checkinCodeInput" placeholder="6-digit check-in code">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="checkinWithCode(${activityId})">Confirm check-in</button>
                        </div>
                    </div>
                `;
                
                // 标签切换
                const tabs = checkinModalBody.querySelectorAll('.checkin-tab');
                const contents = checkinModalBody.querySelectorAll('.checkin-content');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        
                        tabs.forEach(t => t.classList.remove('active'));
                        contents.forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        document.getElementById(`${tabName}Content`).classList.add('active');
                    });
                });
                
                checkinModal.style.display = 'flex';
            } catch (error) {
                console.error('Failed to obtain QR code:', error);
                alert('Failed to retrieve check-in information, please try again.');
            }
        }
        
        // 模拟扫码签到
        async function simulateQRCodeCheckin(activityId) {
            try {
                // 获取活动信息
                const activityResponse = await fetch(`${API_BASE}/activities/${activityId}/checkin-status`);
                const activityResult = await activityResponse.json();
                
                if (!activityResult.success) {
                    alert('Failed to retrieve event information');
                    return;
                }
                
                const qrCodeData = `checkin:${activityId}:${activityResult.data.checkinCode}`;
                
                const response = await fetch(`${API_BASE}/checkin/qrcode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qrCodeData: qrCodeData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Sign in successfully！');
                    checkinModal.style.display = 'none';
                    detailModal.style.display = 'none';
                    loadRegistrations();
                } else {
                    alert('Sign in failed: ' + result.message);
                }
            } catch (error) {
                console.error('QR code check-in failed:', error);
                alert('Check-in failed, please try again.');
            }
        }
        
        // 使用签到码签到
        async function checkinWithCode(activityId) {
            const checkinCode = document.getElementById('checkinCodeInput').value.trim();
            
            if (!checkinCode) {
                alert('Please enter your check-in code.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/checkin/code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        activityId: activityId,
                        checkinCode: checkinCode
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Sign in successfully！');
                    checkinModal.style.display = 'none';
                    detailModal.style.display = 'none';
                    loadRegistrations();
                } else {
                    alert('Sign in failed: ' + result.message);
                }
            } catch (error) {
                console.error('Sign-in failed:', error);
                alert('Check-in failed, please try again.');
            }
        }
        
        // 显示补签申请
        async function showMakeupApplication(activityId) {
            currentActivityId = activityId;
            
            makeupModalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Reason for re-signing</label>
                    <textarea class="form-control" id="makeupReason" rows="4" placeholder="Please explain why a supplementary signature is required."></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="submitMakeupApplication(${activityId})">Submit application</button>
                    <button class="btn btn-default" onclick="makeupModal.style.display='none'">Cancel</button>
                </div>
            `;
            
            makeupModal.style.display = 'flex';
        }
        
        // 提交补签申请
        async function submitMakeupApplication(activityId) {
            const reason = document.getElementById('makeupReason').value.trim();
            
            if (!reason) {
                alert('Please enter the reason for the re-signing.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/checkin/makeup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        activityId: activityId,
                        reason: reason
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('The application for supplementary visa processing has been submitted; please wait for review.');
                    makeupModal.style.display = 'none';
                    detailModal.style.display = 'none';
                } else {
                    alert('Submission failed: ' + result.message);
                }
            } catch (error) {
                console.error('Application for visa resubmission failed:', error);
                alert('Submission failed, please try again.');
            }
        }
        
        // 修改报名信息
        async function editRegistration(id) {
            try {
                const response = await fetch(`${API_BASE}/registrations/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const registration = result.data;
                    
                    modalTitle.textContent = 'Modify registration information';
                    modalBody.innerHTML = `
                        <form id="editForm">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" value="${registration.formData.name}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Telephone</label>
                                <input type="tel" class="form-control" name="phone" value="${registration.formData.phone}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">email</label>
                                <input type="email" class="form-control" name="email" value="${registration.formData.email}" required>
                            </div>
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">Save changes</button>
                                <button type="button" class="btn btn-default" onclick="detailModal.style.display='none'">Cancel</button>
                            </div>
                        </form>
                    `;
                    
                    document.getElementById('editForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const formData = new FormData(e.target);
                        const data = {
                            formData: {
                                name: formData.get('name'),
                                phone: formData.get('phone'),
                                email: formData.get('email'),
                                company: formData.get('company'),
                                position: formData.get('position')
                            }
                        };
                        
                        try {
                            const updateResponse = await fetch(`${API_BASE}/registrations/${id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data)
                            });
                            
                            const updateResult = await updateResponse.json();
                            
                            if (updateResult.success) {
                                alert('Registration information has been updated.');
                                detailModal.style.display = 'none';
                                loadRegistrations();
                            } else {
                                alert('Update failed: ' + updateResult.message);
                            }
                        } catch (error) {
                            console.error('Registration information update failed:', error);
                            alert('Update failed, please try again.');
                        }
                    });
                    
                    detailModal.style.display = 'flex';
                }
            } catch (error) {
                console.error('Failed to retrieve registration information:', error);
                alert('Information retrieval failed, please try again.');
            }
        }
        
        // 取消报名
        async function cancelRegistration(id) {
            if (!confirm('Are you sure you want to cancel your registration? This action is irreversible.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/registrations/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Registration has been cancelled');
                    detailModal.style.display = 'none';
                    loadRegistrations();
                } else {
                    alert('Cancellation failed: ' + result.message);
                }
            } catch (error) {
                console.error('Failed to cancel registration:', error);
                alert('Cancellation failed, please try again.');
            }
        }
        
        // 设置/取消活动提醒
        async function toggleReminder(id, setReminder) {
            try {
                const response = await fetch(`${API_BASE}/registrations/${id}/reminder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reminderSet: setReminder
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    detailModal.style.display = 'none';
                    loadRegistrations();
                } else {
                    alert('Operation failed: ' + result.message);
                }
            } catch (error) {
                console.error('Failed to set reminder:', error);
                alert('Operation failed, please try again.');
            }
        }
    </script>
</body>
</html>
